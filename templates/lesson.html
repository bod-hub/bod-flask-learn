{% extends 'base.html' %}

{% block content %}
<div class="breadcrumbs">
    <a href="{{ url_for('public.index') }}">Главная</a> /
    <a href="{{ url_for('public.section_view', section_number=section.number, section_slug=section.slug) }}">Раздел {{
        section.number }}</a> /
    Урок {{ lesson.number }}
</div>

<article class="lesson-content">
    <h2>{{ lesson.name }}</h2>

    <section class="lesson-theory">
        <div class="content-block">
            {{ lesson.content.get('theory_html', '') | safe }}
        </div>
    </section>

    {% if lesson.content.get('tests') %}
    <section class="lesson-tests">
        <h3>Тестирование</h3>
        <div class="test-grid">
            {% for test in lesson.content.tests %}
            <div class="test-card" id="test-{{ test.id }}" data-correct="{{ test.correct_index }}">
                <p class="test-question"><strong>{{ test.question }}</strong></p>
                <div class="test-options">
                    {% for option in test.options %}
                    <label class="test-option">
                        <input type="radio" name="test_{{ test.id }}" value="{{ loop.index0 }}"
                            onchange="checkAnswer(this)">
                        <span>{{ option }}</span>
                    </label>
                    {% endfor %}
                </div>
                <div class="test-message"></div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if lesson.content.get('tasks') %}
    <section class="lesson-tasks">
        <h3>Задачи</h3>
        {% for task in lesson.content.tasks %}
        <div class="task-card"
            style="margin-bottom: 2rem; padding: 1.5rem; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--radius);">
            <h4 style="margin-top: 0;">Задача {{ loop.index }}</h4>
            <div class="content-block">
                {{ task.content | safe }}
            </div>
        </div>
        {% endfor %}
    </section>
    {% elif lesson.content.get('task_html') %}
    <section class="lesson-task">
        <h2>Задача</h2>
        <div class="content-block">
            {{ lesson.content.get('task_html', '') | safe }}
        </div>
    </section>
    {% endif %}

    <div class="lesson-navigation">
        {% if prev_lesson %}
        <a href="{{ url_for('public.lesson_view', section_number=section.number, section_slug=section.slug, lesson_number=prev_lesson.number, lesson_slug=prev_lesson.slug) }}"
            class="btn btn-primary">
            &larr; Предыдущий
        </a>
        {% else %}
        <span></span> <!-- Spacer -->
        {% endif %}

        <a href="{{ url_for('public.section_view', section_number=section.number, section_slug=section.slug) }}"
            class="btn btn-primary">
            В оглавление раздела
        </a>

        {% if next_lesson %}
        <a href="{{ url_for('public.lesson_view', section_number=section.number, section_slug=section.slug, lesson_number=next_lesson.number, lesson_slug=next_lesson.slug) }}"
            class="btn btn-primary">
            Следующий &rarr;
        </a>
        {% else %}
        <!-- Last lesson of section, link to index or next section? Regs say "Home page" -->
        <a href="{{ url_for('public.index') }}" class="btn btn-primary">
            Главная &rarr;
        </a>
        {% endif %}
    </div>
</article>

<script>
    function checkAnswer(input) {
        const card = input.closest('.test-card');
        if (card.classList.contains('answered')) return;

        const correctIndex = parseInt(card.dataset.correct);
        const selectedIndex = parseInt(input.value);
        const options = card.querySelectorAll('.test-option');

        card.classList.add('answered');

        if (selectedIndex === correctIndex) {
            options[selectedIndex].classList.add('correct-answer');
        } else {
            options[selectedIndex].classList.add('wrong-answer');
            options[correctIndex].classList.add('correct-answer');
        }
    }
</script>
{% endblock %}